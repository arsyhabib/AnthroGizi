{% extends "base.html" %}
{% block content %}
<div class="container py-5">
    <h2 class="text-center mb-4" style="color: {{ theme.text }}">Analisis Kecepatan Pertumbuhan</h2>
    
    <div class="card border-0 shadow-sm rounded-4 p-4">
        <div class="table-responsive mb-3">
            <table class="table" id="pointsTable">
                <thead>
                    <tr>
                        <th>Tanggal</th>
                        <th>Berat (kg)</th>
                        <th>Tinggi (cm)</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
        <button class="btn btn-outline-primary mb-3" onclick="addPointRow()">
            <i class="fas fa-plus"></i> Tambah Data Pengukuran
        </button>
        <button class="btn btn-primary w-100" onclick="calculateVelocity()">
            Analisis Tren
        </button>
    </div>

    <div id="resultSection" class="d-none mt-4">
        <div class="alert alert-info" id="velocityResult"></div>
        <div id="velocityChart" class="text-center"></div>
    </div>
</div>

<script>
function addPointRow() {
    const tbody = document.querySelector('#pointsTable tbody');
    const row = `
        <tr>
            <td><input type="date" class="form-control date-input"></td>
            <td><input type="number" step="0.01" class="form-control weight-input"></td>
            <td><input type="number" step="0.1" class="form-control height-input"></td>
            <td><button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()"><i class="fas fa-trash"></i></button></td>
        </tr>
    `;
    tbody.insertAdjacentHTML('beforeend', row);
}

async function calculateVelocity() {
    const rows = document.querySelectorAll('#pointsTable tbody tr');
    const points = Array.from(rows).map(row => ({
        date: row.querySelector('.date-input').value,
        weight: row.querySelector('.weight-input').value,
        height: row.querySelector('.height-input').value
    })).filter(p => p.date && p.weight); // Filter data kosong

    if (points.length < 2) {
        alert("Masukkan minimal 2 data pengukuran!");
        return;
    }

    const res = await fetch('/api/growth-velocity-multi', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ points })
    });
    
    const data = await res.json();
    if (data.error) return alert(data.error);

    document.getElementById('resultSection').classList.remove('d-none');
    document.getElementById('velocityResult').innerHTML = 
        `<strong>Laju Kenaikan Berat:</strong> ${data.velocity.weight} <br> Status: ${data.status}`;
    
    const img = document.createElement('img');
    img.src = 'data:image/png;base64,' + data.chart;
    img.className = 'img-fluid';
    document.getElementById('velocityChart').innerHTML = '';
    document.getElementById('velocityChart').appendChild(img);
}

// Init 2 baris awal
addPointRow(); addPointRow();
</script>
{% endblock %}
