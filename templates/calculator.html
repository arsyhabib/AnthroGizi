{% extends "base.html" %}

{% block content %}
<div class="container py-5">
    <div class="row mb-4 text-center">
        <div class="col-12">
            <h2 class="fw-bold" style="color: {{ theme.text }}">
                <i class="fas fa-calculator me-2"></i>Kalkulator Gizi Profesional
            </h2>
            <p class="text-muted">Pantau status gizi anak dengan standar WHO 2006 & Permenkes RI</p>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-5 mb-4">
            <div class="card shadow-sm border-0 rounded-4 h-100">
                <div class="card-header bg-white border-0 pt-4 px-4">
                    <h5 class="card-title mb-0 fw-bold" style="color: {{ theme.primary }}">
                        <i class="fas fa-user-edit me-2"></i>Data Anak
                    </h5>
                </div>
                <div class="card-body p-4">
                    <form id="anthroForm">
                        <div class="mb-3">
                            <label class="form-label small text-uppercase fw-bold text-muted">Identitas</label>
                            <div class="row g-2">
                                <div class="col-6">
                                    <input type="text" class="form-control" id="child_name" placeholder="Nama Anak">
                                </div>
                                <div class="col-6">
                                    <input type="text" class="form-control" id="mother_name" placeholder="Nama Ibu (Wajib)" required>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Jenis Kelamin</label>
                            <div class="d-flex gap-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="gender" id="male" value="M" checked>
                                    <label class="form-check-label" for="male"><i class="fas fa-mars text-primary me-1"></i>Laki-laki</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="gender" id="female" value="F">
                                    <label class="form-check-label" for="female"><i class="fas fa-venus text-danger me-1"></i>Perempuan</label>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small text-uppercase fw-bold text-muted">Metode Input Usia</label>
                            <ul class="nav nav-pills nav-fill mb-3 gap-2" id="ageTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active p-1 border" id="dob-tab" data-bs-toggle="tab" data-bs-target="#dob-panel" type="button" role="tab">
                                        <small>Tanggal Lahir</small>
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link p-1 border" id="age-tab" data-bs-toggle="tab" data-bs-target="#age-panel" type="button" role="tab">
                                        <small>Umur (Bulan)</small>
                                    </button>
                                </li>
                            </ul>
                            
                            <div class="tab-content" id="ageTabContent">
                                <div class="tab-pane fade show active" id="dob-panel" role="tabpanel">
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <label class="form-label small">Tgl Lahir</label>
                                            <input type="date" class="form-control" id="dob">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label small">Tgl Ukur</label>
                                            <input type="date" class="form-control" id="measure_date">
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="age-panel" role="tabpanel">
                                    <label class="form-label small">Usia (Bulan)</label>
                                    <input type="number" step="0.1" class="form-control" id="age_months" placeholder="Contoh: 24.5">
                                    <div class="form-text text-muted">Gunakan titik (.) untuk desimal</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label small text-uppercase fw-bold text-muted">Hasil Ukur</label>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Berat (kg)</label>
                                    <input type="number" step="0.01" class="form-control" id="weight" required placeholder="0.0">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Tinggi (cm)</label>
                                    <input type="number" step="0.1" class="form-control" id="height" required placeholder="0.0">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">L.Kepala (cm)</label>
                                    <input type="number" step="0.1" class="form-control" id="head_circ" placeholder="Opsional">
                                </div>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-lg text-white shadow-sm" 
                                    style="background: {{ theme.gradient }}; border: none; border-radius: 12px;">
                                <i class="fas fa-calculator me-2"></i>Analisis Sekarang
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-7 d-none" id="resultSection">
            
            <div class="card shadow-sm border-0 rounded-4 mb-4 bg-light">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="card-title fw-bold text-dark mb-1">Ringkasan Hasil</h5>
                            <p class="text-muted mb-0" id="resultSummary">...</p>
                            <small class="text-primary" id="childInfoDetail"></small>
                        </div>
                        <button onclick="window.print()" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-print me-1"></i>Cetak/PDF
                        </button>
                    </div>
                </div>
            </div>

            <div class="row g-3 mb-4" id="indicatorGrid">
                </div>

            <div class="card shadow-sm border-0 rounded-4">
                <div class="card-header bg-white border-bottom">
                    <ul class="nav nav-tabs card-header-tabs" id="resultTabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-charts">
                                <i class="fas fa-chart-area me-2"></i>Grafik Pertumbuhan
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-tips">
                                <i class="fas fa-user-md me-2"></i>Saran Profesional
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body p-4">
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="tab-charts">
                            <div id="chartsContainer" class="text-center">
                                <p class="text-muted">Grafik akan muncul di sini setelah analisis.</p>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="tab-tips">
                            <ul class="list-group list-group-flush" id="tipsList">
                                </ul>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-none justify-content-center align-items-center" 
     style="background: rgba(255,255,255,0.8); z-index: 9999;">
    <div class="text-center">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-2 fw-bold text-muted">Sedang Menganalisis Data...</p>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set default Measure Date to Today
    document.getElementById('measure_date').valueAsDate = new Date();

    const form = document.getElementById('anthroForm');
    const loading = document.getElementById('loadingOverlay');
    const resultSec = document.getElementById('resultSection');

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        loading.classList.remove('d-none');
        loading.classList.add('d-flex');

        // Collect Data
        const payload = {
            mother_name: document.getElementById('mother_name').value,
            gender: document.querySelector('input[name="gender"]:checked').value,
            weight: document.getElementById('weight').value,
            height: document.getElementById('height').value,
            head_circumference: document.getElementById('head_circ').value,
            
            // Age Logic
            age_input_type: document.querySelector('#age-tab.active') ? 'months' : 'date',
            dob: document.getElementById('dob').value,
            measure_date: document.getElementById('measure_date').value,
            age_months: document.getElementById('age_months').value
        };

        try {
            const response = await fetch('/api/calculate-all', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (data.error) {
                alert('Error: ' + data.error);
                loading.classList.add('d-none');
                loading.classList.remove('d-flex');
                return;
            }

            // 1. Render Summary
            document.getElementById('resultSummary').textContent = data.summary;
            document.getElementById('childInfoDetail').textContent = 
                `Ibu: ${data.child_info.mother_name} | Usia: ${data.child_info.age_display} (${data.child_info.age_days} hari)`;

            // 2. Render Indicator Cards
            const grid = document.getElementById('indicatorGrid');
            grid.innerHTML = '';
            
            const labels = {
                'wfa': 'Berat/Umur', 'hfa': 'Tinggi/Umur', 
                'wfh': 'Berat/Tinggi', 'bfa': 'IMT/Umur', 'hcfa': 'Lingkar Kepala'
            };

            for (const [key, res] of Object.entries(data.results)) {
                if (!res.z_score) continue; // Skip if no data

                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4';
                col.innerHTML = `
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <h6 class="text-muted small text-uppercase mb-2">${labels[key] || key}</h6>
                            <h4 class="fw-bold mb-1" style="color: ${res.color}">${res.status}</h4>
                            <div class="d-flex justify-content-between align-items-end mt-3">
                                <span class="badge bg-light text-dark border">Z: ${res.z_score}</span>
                                <span class="h5 mb-0 text-muted">${res.value}</span>
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(col);
            }

            // 3. Render Charts
            const chartContainer = document.getElementById('chartsContainer');
            chartContainer.innerHTML = '';
            
            if (Object.keys(data.charts).length > 0) {
                for (const [key, imgBase64] of Object.entries(data.charts)) {
                    const img = document.createElement('img');
                    img.src = 'data:image/png;base64,' + imgBase64;
                    img.className = 'img-fluid rounded shadow-sm mb-4 border';
                    img.style.maxHeight = '400px';
                    chartContainer.appendChild(img);
                }
            } else {
                chartContainer.innerHTML = '<p class="text-muted py-5">Grafik tidak tersedia untuk data ini.</p>';
            }

            // 4. Render Tips
            const tipsList = document.getElementById('tipsList');
            tipsList.innerHTML = '';
            data.tips.forEach(tip => {
                const li = document.createElement('li');
                li.className = 'list-group-item border-0 ps-0';
                li.innerHTML = `<i class="fas fa-check-circle text-success me-2"></i>${tip}`;
                tipsList.appendChild(li);
            });

            // Show Results & Scroll
            resultSec.classList.remove('d-none');
            resultSec.scrollIntoView({ behavior: 'smooth' });

        } catch (err) {
            console.error(err);
            alert('Gagal menghubungi server. Coba lagi.');
        } finally {
            loading.classList.add('d-none');
            loading.classList.remove('d-flex');
        }
    });
});
</script>
{% endblock %}
