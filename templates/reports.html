{% extends "base.html" %}

{% block title %}Reports & Analytics - anthroGizi v4.0.0{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="page-header d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6 fw-bold text-gradient">Reports & Analytics</h1>
                    <p class="lead">Analisis pertumbuhan dan perkembangan anak dengan data visual</p>
                </div>
                <div class="report-actions">
                    <button class="btn btn-outline-primary me-2" onclick="exportPDF()">
                        <i class="fas fa-file-pdf me-1"></i>Export PDF
                    </button>
                    <button class="btn btn-outline-success me-2" onclick="exportExcel()">
                        <i class="fas fa-file-excel me-1"></i>Export Excel
                    </button>
                    <button class="btn btn-primary" onclick="generateReport()">
                        <i class="fas fa-chart-line me-1"></i>Generate Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Overview -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stats-icon bg-primary">
                            <i class="fas fa-child text-white"></i>
                        </div>
                        <div class="ms-3">
                            <h3 class="mb-0" id="totalChildren">0</h3>
                            <p class="text-muted mb-0">Total Anak Terdata</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stats-icon bg-success">
                            <i class="fas fa-chart-line text-white"></i>
                        </div>
                        <div class="ms-3">
                            <h3 class="mb-0" id="growthRate">0%</h3>
                            <p class="text-muted mb-0">Pertumbuhan Normal</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stats-icon bg-warning">
                            <i class="fas fa-exclamation-triangle text-white"></i>
                        </div>
                        <div class="ms-3">
                            <h3 class="mb-0" id="atRiskCount">0</h3>
                            <p class="text-muted mb-0">Anak Berisiko</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stats-icon bg-info">
                            <i class="fas fa-calendar-check text-white"></i>
                        </div>
                        <div class="ms-3">
                            <h3 class="mb-0" id="recentChecks">0</h3>
                            <p class="text-muted mb-0">Pemeriksaan Bulan Ini</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row mb-4">
        <!-- Growth Trends Chart -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Tren Pertumbuhan
                    </h5>
                    <div class="chart-controls">
                        <select class="form-select form-select-sm" id="chartPeriod" onchange="updateChartPeriod()">
                            <option value="3">3 Bulan Terakhir</option>
                            <option value="6">6 Bulan Terakhir</option>
                            <option value="12" selected>1 Tahun Terakhir</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="growthChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Distribution Chart -->
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>
                        Distribusi Status Gizi
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="nutritionChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Analysis -->
    <div class="row mb-4">
        <!-- Age Group Analysis -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>
                        Analisis Berdasarkan Kelompok Usia
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="ageGroupChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Gender Analysis -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-venus-mars me-2"></i>
                        Analisis Berdasarkan Gender
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="genderChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>
                        Daftar Pemeriksaan Terbaru
                    </h5>
                    <div class="table-controls">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" placeholder="Cari data..." id="tableSearch">
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="dataTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Nama Anak</th>
                                    <th>Usia</th>
                                    <th>Berat Badan</th>
                                    <th>Tinggi Badan</th>
                                    <th>Z-Score BB/TB</th>
                                    <th>Status Gizi</th>
                                    <th>Tanggal Periksa</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody">
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.stats-card {
    border-left: 4px solid var(--primary-color);
    transition: transform 0.2s ease;
}

.stats-card:hover {
    transform: translateY(-2px);
}

.stats-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.chart-controls .form-select {
    width: auto;
}

.table-controls .input-group {
    width: 250px;
}

.report-actions .btn {
    margin-bottom: 0.25rem;
}

.status-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.action-btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

.section-title {
    color: var(--primary-color);
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 0.5rem;
}

#dataTable th {
    white-space: nowrap;
}

#dataTable td {
    vertical-align: middle;
}
</style>

<script>
// Reports and Analytics System
class ReportsSystem {
    constructor() {
        this.charts = {};
        this.sampleData = this.generateSampleData();
        this.initializeCharts();
        this.populateStats();
        this.populateTable();
    }

    generateSampleData() {
        const names = ['Andi', 'Budi', 'Citra', 'Dewi', 'Eko', 'Fitri', 'Ghani', 'Hana', 'Irfan', 'Juli'];
        const data = [];
        
        for (let i = 0; i < 50; i++) {
            const age = Math.floor(Math.random() * 60) + 1; // 1-60 months
            const weight = this.calculateWeightForAge(age);
            const height = this.calculateHeightForAge(age);
            const zScore = (Math.random() - 0.5) * 4; // -2 to +2
            
            data.push({
                id: i + 1,
                name: names[Math.floor(Math.random() * names.length)] + ` ${i + 1}`,
                age: age,
                weight: weight,
                height: height,
                zScore: zScore,
                status: this.getNutritionStatus(zScore),
                date: this.generateRandomDate(),
                gender: Math.random() > 0.5 ? 'L' : 'P'
            });
        }
        
        return data.sort((a, b) => new Date(b.date) - new Date(a.date));
    }

    calculateWeightForAge(age) {
        // Simplified calculation for demo
        if (age <= 12) return 3 + (age * 0.5) + (Math.random() - 0.5);
        if (age <= 24) return 9 + ((age - 12) * 0.3) + (Math.random() - 0.5);
        return 12 + ((age - 24) * 0.2) + (Math.random() - 0.5);
    }

    calculateHeightForAge(age) {
        // Simplified calculation for demo
        if (age <= 12) return 50 + (age * 2.5) + (Math.random() - 0.5) * 5;
        if (age <= 24) return 80 + ((age - 12) * 1.5) + (Math.random() - 0.5) * 5;
        return 98 + ((age - 24) * 1.2) + (Math.random() - 0.5) * 5;
    }

    getNutritionStatus(zScore) {
        if (zScore < -2) return 'Gizi Buruk';
        if (zScore < -1) return 'Gizi Kurang';
        if (zScore > 2) return 'Gizi Lebih';
        return 'Gizi Baik';
    }

    generateRandomDate() {
        const start = new Date(2024, 0, 1);
        const end = new Date();
        return new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime()));
    }

    populateStats() {
        const totalChildren = this.sampleData.length;
        const normalGrowth = this.sampleData.filter(d => d.zScore >= -1 && d.zScore <= 1).length;
        const atRisk = this.sampleData.filter(d => d.zScore < -2 || d.zScore > 2).length;
        const recentChecks = this.sampleData.filter(d => {
            const checkDate = new Date(d.date);
            const monthAgo = new Date();
            monthAgo.setMonth(monthAgo.getMonth() - 1);
            return checkDate >= monthAgo;
        }).length;

        this.animateCounter('totalChildren', totalChildren);
        this.animateCounter('growthRate', Math.round((normalGrowth / totalChildren) * 100), '%');
        this.animateCounter('atRiskCount', atRisk);
        this.animateCounter('recentChecks', recentChecks);
    }

    animateCounter(elementId, target, suffix = '') {
        const element = document.getElementById(elementId);
        let current = 0;
        const increment = target / 50;
        const timer = setInterval(() => {
            current += increment;
            if (current >= target) {
                current = target;
                clearInterval(timer);
            }
            element.textContent = Math.floor(current) + suffix;
        }, 20);
    }

    initializeCharts() {
        this.initGrowthChart();
        this.initNutritionChart();
        this.initAgeGroupChart();
        this.initGenderChart();
    }

    initGrowthChart() {
        const ctx = document.getElementById('growthChart').getContext('2d');
        
        // Generate sample growth data
        const months = [];
        const weights = [];
        const heights = [];
        
        for (let i = 1; i <= 12; i++) {
            months.push(`Bulan ${i}`);
            weights.push(3 + (i * 0.6) + (Math.random() - 0.5) * 0.5);
            heights.push(50 + (i * 2.5) + (Math.random() - 0.5) * 2);
        }

        this.charts.growth = new Chart(ctx, {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: 'Berat Badan (kg)',
                    data: weights,
                    borderColor: '#4e73df',
                    backgroundColor: 'rgba(78, 115, 223, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Tinggi Badan (cm)',
                    data: heights,
                    borderColor: '#1cc88a',
                    backgroundColor: 'rgba(28, 200, 138, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });
    }

    initNutritionChart() {
        const ctx = document.getElementById('nutritionChart').getContext('2d');
        
        const statusCounts = {
            'Gizi Baik': this.sampleData.filter(d => d.status === 'Gizi Baik').length,
            'Gizi Kurang': this.sampleData.filter(d => d.status === 'Gizi Kurang').length,
            'Gizi Buruk': this.sampleData.filter(d => d.status === 'Gizi Buruk').length,
            'Gizi Lebih': this.sampleData.filter(d => d.status === 'Gizi Lebih').length
        };

        this.charts.nutrition = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(statusCounts),
                datasets: [{
                    data: Object.values(statusCounts),
                    backgroundColor: [
                        '#1cc88a',
                        '#f6c23e',
                        '#e74a3b',
                        '#4e73df'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    initAgeGroupChart() {
        const ctx = document.getElementById('ageGroupChart').getContext('2d');
        
        const ageGroups = {
            '0-6 bulan': this.sampleData.filter(d => d.age <= 6).length,
            '7-12 bulan': this.sampleData.filter(d => d.age > 6 && d.age <= 12).length,
            '13-24 bulan': this.sampleData.filter(d => d.age > 12 && d.age <= 24).length,
            '25-36 bulan': this.sampleData.filter(d => d.age > 24 && d.age <= 36).length,
            '37-60 bulan': this.sampleData.filter(d => d.age > 36 && d.age <= 60).length
        };

        this.charts.ageGroup = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(ageGroups),
                datasets: [{
                    label: 'Jumlah Anak',
                    data: Object.values(ageGroups),
                    backgroundColor: '#4e73df'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    initGenderChart() {
        const ctx = document.getElementById('genderChart').getContext('2d');
        
        const genderData = {
            'Laki-laki': this.sampleData.filter(d => d.gender === 'L').length,
            'Perempuan': this.sampleData.filter(d => d.gender === 'P').length
        };

        this.charts.gender = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(genderData),
                datasets: [{
                    label: 'Jumlah Anak',
                    data: Object.values(genderData),
                    backgroundColor: ['#4e73df', '#e83e8c']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    populateTable() {
        const tbody = document.getElementById('dataTableBody');
        tbody.innerHTML = '';
        
        // Show only first 10 records
        const displayData = this.sampleData.slice(0, 10);
        
        displayData.forEach(record => {
            const row = document.createElement('tr');
            
            const statusClass = this.getStatusClass(record.status);
            
            row.innerHTML = `
                <td>${record.name}</td>
                <td>${record.age} bulan</td>
                <td>${record.weight.toFixed(1)} kg</td>
                <td>${record.height.toFixed(1)} cm</td>
                <td>${record.zScore.toFixed(2)}</td>
                <td>
                    <span class="badge ${statusClass} status-badge">${record.status}</span>
                </td>
                <td>${new Date(record.date).toLocaleDateString('id-ID')}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary action-btn" onclick="viewDetail('${record.id}')">
                        <i class="fas fa-eye me-1"></i>Detail
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }

    getStatusClass(status) {
        switch(status) {
            case 'Gizi Baik': return 'bg-success';
            case 'Gizi Kurang': return 'bg-warning';
            case 'Gizi Buruk': return 'bg-danger';
            case 'Gizi Lebih': return 'bg-info';
            default: return 'bg-secondary';
        }
    }

    updateChartPeriod() {
        const period = document.getElementById('chartPeriod').value;
        // Update chart data based on selected period
        showNotification(`Chart diperbarui untuk periode ${period} bulan`, 'info');
    }

    exportPDF() {
        showNotification('Mempersiapkan export PDF...', 'info');
        // In a real application, this would generate and download a PDF report
        setTimeout(() => {
            showNotification('Report PDF berhasil diunduh!', 'success');
        }, 2000);
    }

    exportExcel() {
        showNotification('Mempersiapkan export Excel...', 'info');
        // In a real application, this would generate and download an Excel file
        setTimeout(() => {
            showNotification('Data Excel berhasil diunduh!', 'success');
        }, 2000);
    }

    generateReport() {
        showNotification('Menghasilkan laporan lengkap...', 'info');
        // In a real application, this would generate a comprehensive report
        setTimeout(() => {
            showNotification('Laporan berhasil dihasilkan!', 'success');
        }, 1500);
    }
}

// Global functions
function updateChartPeriod() {
    reportsSystem.updateChartPeriod();
}

function exportPDF() {
    reportsSystem.exportPDF();
}

function exportExcel() {
    reportsSystem.exportExcel();
}

function generateReport() {
    reportsSystem.generateReport();
}

function viewDetail(recordId) {
    showNotification(`Menampilkan detail untuk record ${recordId}`, 'info');
    // In a real application, this would show detailed information
}

// Initialize Reports System
let reportsSystem;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Load Chart.js from CDN
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    script.onload = function() {
        reportsSystem = new ReportsSystem();
    };
    document.head.appendChild(script);
    
    // Add search functionality to table
    document.getElementById('tableSearch').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('#dataTableBody tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    });
});
</script>
{% endblock %}